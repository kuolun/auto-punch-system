# 🤖 自動打卡系統 v3.0

一個基於 Streamlit 的自動化工作日誌打卡系統，讓員工能夠快速且安全地完成每日打卡作業。

## 📋 目錄

- [系統概述](#系統概述)
- [程式架構](#程式架構)
- [功能特色](#功能特色)
- [技術規格](#技術規格)
- [安裝與部署](#安裝與部署)
- [使用說明](#使用說明)
- [API 介接](#api-介接)
- [安全機制](#安全機制)
- [故障排除](#故障排除)
- [更新日誌](#更新日誌)

## 🎯 系統概述

### 目的
自動化員工打卡流程，透過 Web 介面提供簡易的批次打卡功能，減少重複性作業並提高工作效率。

### 主要特點
- ✅ **自動抓取案件清單**：從系統自動取得員工專屬案件
- 🔄 **批次處理**：一次處理多個案件，提高效率
- 🛡️ **安全驗證**：需要員工編號和密碼驗證
- 📊 **即時回饋**：提供詳細的執行結果和進度顯示
- 💾 **歷史記錄**：保存執行歷史，可匯出記錄
- 🌏 **時區支援**：支援台灣時區 (UTC+8)

## 🏗️ 程式架構

### 整體架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                    Streamlit Web App                       │
├─────────────────────────────────────────────────────────────┤
│  Frontend (UI Layer)                                       │
│  ├── 使用者輸入界面 (員工編號、密碼)                           │
│  ├── 案件管理界面 (自動抓取、顯示清單)                         │
│  ├── 執行控制界面 (測試連線、開始打卡)                         │
│  └── 結果顯示界面 (進度條、歷史記錄)                           │
├─────────────────────────────────────────────────────────────┤
│  Business Logic Layer                                      │
│  ├── 時間處理模組 (台灣時區)                                  │
│  ├── 資料驗證模組 (輸入檢查)                                  │
│  ├── 案件處理模組 (批次作業)                                  │
│  └── 狀態管理模組 (Session State)                           │
├─────────────────────────────────────────────────────────────┤
│  API Integration Layer                                     │
│  ├── HTTP 請求處理 (requests)                               │
│  ├── HTML 解析 (BeautifulSoup)                             │
│  ├── 資料提取與轉換                                          │
│  └── 錯誤處理與重試                                          │
├─────────────────────────────────────────────────────────────┤
│  External API                                              │
│  └── herbworklog.netlify.app/.netlify/functions           │
│      ├── /case_list (案件清單)                              │
│      ├── /case_edit (案件編輯)                              │
│      └── /sql_for_case (資料提交)                           │
└─────────────────────────────────────────────────────────────┘
```

### 核心模組說明

#### 1. 🎨 前端介面模組 (Frontend UI)
- **檔案**：`streamlit_app.py` (行 168-653)
- **功能**：
  - 使用者資訊輸入界面
  - 案件清單管理界面
  - 執行控制與監控
  - 結果展示與歷史記錄

#### 2. ⏰ 時間處理模組 (Time Management)
- **檔案**：`streamlit_app.py` (行 43-56)
- **功能**：
  ```python
  # 核心函數
  get_taiwan_time()          # 取得台灣當前時間
  get_taiwan_date_string()   # 取得日期字串 (YYYY-MM-DD)
  get_taiwan_datetime_string() # 取得完整時間字串
  ```

#### 3. 📡 API 介接模組 (API Integration)
- **檔案**：`streamlit_app.py` (行 59-162)
- **核心函數**：
  ```python
  fetch_case_list(user_id, password)    # 自動抓取案件清單
  fetch_case_edit(case_key, case_list, user_id)  # 取得案件編輯頁面
  extract_fields(doc, today, user_id, punch_message)  # 提取表單欄位
  submit_punch(payload)  # 提交打卡資料
  ```

#### 4. 💾 資料處理模組 (Data Processing)
- **功能**：
  - HTML 解析與資料提取
  - 表單欄位映射與驗證
  - JSON 資料序列化
  - 快取機制 (TTL: 5分鐘)

#### 5. 📊 狀態管理模組 (State Management)
- **Session State 管理**：
  ```python
  st.session_state.punch_log        # 執行歷史記錄
  st.session_state.auto_case_list   # 自動抓取的案件清單
  ```

## 🌟 功能特色

### 1. 🔄 自動案件抓取
- **智能抓取**：根據員工帳號自動取得專屬案件清單
- **HTML 解析**：解析系統回傳的表格資料
- **快取機制**：避免重複請求，提升效能
- **錯誤處理**：提供詳細的錯誤診斷資訊

### 2. 📋 批次打卡處理
- **多案件支援**：一次處理多個案件
- **進度顯示**：即時顯示處理進度
- **並行處理**：優化處理速度
- **結果追蹤**：詳細記錄每個案件的處理結果

### 3. 🛡️ 安全機制
- **身份驗證**：需要有效的員工編號和密碼
- **權限控制**：只能存取員工專屬案件
- **連線測試**：執行前驗證系統連線
- **錯誤隔離**：單一案件錯誤不影響其他案件

### 4. 📊 監控與記錄
- **即時監控**：顯示處理狀態和進度
- **歷史記錄**：保存所有執行記錄
- **成功率統計**：計算和顯示成功率
- **資料匯出**：支援 JSON 格式匯出

## 🔧 技術規格

### 開發環境
- **語言**：Python 3.11+
- **框架**：Streamlit 1.28.0
- **部署**：雲端平台 (支援容器化)

### 主要依賴
```txt
streamlit==1.28.0      # Web 應用框架
requests==2.31.0       # HTTP 請求處理
beautifulsoup4==4.12.2 # HTML 解析
```

### 系統需求
- **Python**：3.11 或以上版本
- **記憶體**：建議 512MB 以上
- **網路**：需要外部 API 連線能力
- **瀏覽器**：支援現代瀏覽器 (Chrome, Firefox, Safari, Edge)

## 🚀 安裝與部署

### 本地開發環境

1. **克隆專案**
   ```bash
   git clone [repository-url]
   cd auto-punch-system
   ```

2. **安裝依賴**
   ```bash
   pip install -r requirements.txt
   ```

3. **啟動應用**
   ```bash
   streamlit run streamlit_app.py
   ```

4. **存取應用**
   ```
   瀏覽器開啟：http://localhost:8501
   ```

### Docker 部署

1. **建立 Docker 映像**
   ```dockerfile
   FROM python:3.11-slim
   WORKDIR /app
   COPY requirements.txt .
   RUN pip install -r requirements.txt
   COPY . .
   EXPOSE 8501
   CMD ["streamlit", "run", "streamlit_app.py", "--server.port=8501", "--server.address=0.0.0.0"]
   ```

2. **執行容器**
   ```bash
   docker build -t auto-punch-system .
   docker run -p 8501:8501 auto-punch-system
   ```

### 雲端部署
- **Streamlit Cloud**：直接連接 GitHub 倉庫
- **Heroku**：支援 Python 應用部署
- **Railway**：現代化雲端平台
- **Replit**：線上開發與部署平台

## 📖 使用說明

### 🚀 快速開始

1. **填寫登入資訊**
   - 輸入員工編號 (例如：1889)
   - 輸入系統密碼

2. **取得案件清單**
   - 點擊「🔄 自動抓取」按鈕
   - 系統會自動從您的帳號取得案件清單
   - 確認顯示的案件數量和內容

3. **測試系統連線**
   - 點擊「🔍 測試連線」按鈕
   - 確認能正常連接到系統
   - 檢視第一個案件的資訊

4. **執行批次打卡**
   - 點擊「🚀 開始打卡」按鈕
   - 觀察進度條和即時狀態
   - 檢視執行結果

### 🎯 詳細操作步驟

#### 步驟 1：使用者驗證
```
👤 使用者資訊
├── 🆔 員工編號：必填，您的系統帳號
└── 🔐 登入密碼：必填，系統登入密碼
```

#### 步驟 2：案件管理
```
📋 案件設定
├── 🔄 自動抓取：從系統取得專屬案件清單
├── 📋 案件清單：顯示抓取到的案件 (只讀)
└── 💬 打卡訊息：自訂工作日誌內容
```

#### 步驟 3：執行控制
```
🎮 操作區
├── 🔍 測試連線：驗證系統連線和案件存取
└── 🚀 開始打卡：批次處理所有案件
```

#### 步驟 4：結果監控
```
📊 執行結果
├── 📈 即時進度：進度條和狀態訊息
├── 📋 詳細結果：每個案件的處理結果
└── 📝 歷史記錄：保存和匯出執行記錄
```

### 💡 使用技巧

#### 🎯 最佳實務
- **定期重新抓取**：案件清單可能會更新
- **測試連線**：執行前先測試確保系統正常
- **監控結果**：留意失敗案件的錯誤訊息
- **定期匯出**：備份重要的執行記錄

#### ⚠️ 注意事項
- **網路穩定**：確保網路連線穩定
- **帳號正確**：使用正確的員工編號和密碼
- **瀏覽器快取**：如有問題可嘗試清除瀏覽器快取
- **同時使用**：避免多人同時使用同一帳號

## 🔌 API 介接

### 外部 API 端點

#### 1. 案件清單 API
```http
POST /.netlify/functions/case_list
Content-Type: application/x-www-form-urlencoded

user_id=1889&f_password=password&f_password2=&from_case_edit=
```

**回應**：HTML 格式的案件清單表格

#### 2. 案件編輯 API
```http
POST /.netlify/functions/case_edit
Content-Type: application/x-www-form-urlencoded

form_key=00020&table_case_id_list=00020,00021&user_id=1889
```

**回應**：HTML 格式的案件編輯表單

#### 3. 資料提交 API
```http
POST /.netlify/functions/sql_for_case
Content-Type: application/x-www-form-urlencoded

fields={"f_key":123,"f_case_name":"案件名稱",...}
```

**回應**：JSON 格式的處理結果

### 資料結構

#### 案件資料欄位
```python
{
    "f_key": int,           # 案件 ID
    "f_case_name": str,     # 案件名稱
    "f_person_id": str,     # 負責人員 ID
    "f_person2_id": str,    # 第二負責人 ID
    "f_event_date": str,    # 事件日期
    "f_alert_date": str,    # 提醒日期
    "f_log": str,           # 工作日誌
    "f_note": str,          # 備註
    "f_to_do": str,         # 待辦事項
    "f_dir": str,           # 目錄
    "f_risk": str,          # 風險等級
    "f_doc": str,           # 文件
    "f_update_date": str,   # 更新日期
    "f_last_editor": str    # 最後編輯者
}
```

## 🛡️ 安全機制

### 身份驗證
- **雙重驗證**：員工編號 + 密碼
- **Session 管理**：瀏覽器 Session State
- **權限檢查**：只能存取自己的案件

### 資料保護
- **敏感資料**：密碼不儲存在本地
- **傳輸安全**：使用 HTTPS 連線
- **快取控制**：敏感資料不快取

### 錯誤處理
- **輸入驗證**：檢查所有使用者輸入
- **異常捕獲**：妥善處理 API 錯誤
- **資訊洩漏防護**：不顯示敏感錯誤資訊

## 🔧 故障排除

### 常見問題

#### ❌ 無法自動抓取案件清單
**可能原因**：
- 員工編號或密碼錯誤
- 網路連線問題
- API 服務異常

**解決方案**：
1. 檢查員工編號和密碼
2. 測試網路連線
3. 聯繫系統管理員

#### ❌ 打卡提交失敗
**可能原因**：
- 案件不存在或無權限
- 資料格式錯誤
- 系統維護中

**解決方案**：
1. 重新抓取案件清單
2. 檢查案件權限
3. 稍後重試

#### ❌ 頁面載入緩慢
**可能原因**：
- 網路頻寬限制
- 伺服器負載過高
- 快取失效

**解決方案**：
1. 重新整理頁面
2. 清除瀏覽器快取
3. 切換網路環境

### 除錯工具

#### 🔧 系統資訊
- 在側邊欄查看系統狀態
- 檢查台灣時間是否正確
- 查看最近執行的成功率

#### 🧪 測試功能
- 使用「測試連線」驗證 API
- 檢查第一個案件的資訊
- 確認資料提取是否正常

#### 📋 日誌記錄
- 查看詳細的執行歷史
- 分析失敗案件的錯誤訊息
- 匯出記錄進行進一步分析

## 📈 更新日誌

### v3.0 (當前版本)
- ✨ 新增自動案件抓取功能
- 🔄 改進批次處理效能
- 📊 增強執行結果顯示
- 🛡️ 加強安全機制
- 🌏 完整台灣時區支援

### v2.x (舊版本)
- 基本打卡功能
- 手動案件清單輸入
- 簡易結果顯示

### 未來規劃
- 🔔 推播通知功能
- 📱 行動裝置優化
- 🤖 智能排程打卡
- 📊 詳細統計報表
- 🔧 管理員控制面板

## 👥 支援與聯繫

### 技術支援
- **問題回報**：請描述詳細的錯誤情況
- **功能建議**：歡迎提出改進建議
- **使用諮詢**：協助解決使用上的問題

### 系統維護
- **定期更新**：系統會定期更新和維護
- **版本通知**：重大更新會提前通知
- **備份建議**：建議定期匯出重要記錄

---

📝 **最後更新**：2024年12月  
🔖 **版本**：v3.0  
👨‍💻 **維護者**：系統開發團隊 